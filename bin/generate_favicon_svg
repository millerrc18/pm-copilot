#!/usr/bin/env ruby
# frozen_string_literal: true

require "base64"
require "pathname"

source = Pathname.new(ARGV[0] || "public/icon.png").expand_path
output = Pathname.new(ARGV[1] || "app/assets/images/favicon.svg").expand_path

unless source.exist?
  abort "Source PNG not found at #{source}."
end

header = source.binread(24)
magic = "\x89PNG\r\n\x1a\n".b
unless header.start_with?(magic)
  abort "Source file is not a PNG: #{source}."
end

width = header[16, 4].unpack1("N")
height = header[20, 4].unpack1("N")

encoded = Base64.strict_encode64(source.binread)

svg = <<~SVG
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 #{width} #{height}">
    <image href="data:image/png;base64,#{encoded}" width="#{width}" height="#{height}" />
  </svg>
SVG

output.dirname.mkpath
output.write(svg)

puts "Wrote #{output}"
