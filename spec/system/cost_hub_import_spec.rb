require "rails_helper"
require "base64"
require "tempfile"

RSpec.describe "Cost Hub imports", type: :system do
  before do
    driven_by(:rack_test)
  end

  it "imports costs and reflects totals in the Cost Hub" do
    user = User.create!(email: "importer@example.com", password: "password")
    program = Program.create!(name: "Import Program", user: user)
    contract = Contract.create!(
      program: program,
      contract_code: "IMP-001",
      start_date: Date.new(2024, 1, 1),
      end_date: Date.new(2024, 12, 31),
      sell_price_per_unit: 100,
      planned_quantity: 10
    )

    4.times do |index|
      DeliveryUnit.create!(
        contract: contract,
        unit_serial: "IMP-#{index + 1}",
        ship_date: Date.new(2024, 1, 10 + index)
      )
    end

    visit new_user_session_path
    fill_in "Email", with: user.email
    fill_in "Password", with: "password"
    click_button "Sign in"

    visit new_cost_import_path
    select program.name, from: "Program (optional)"
    attach_file "Excel file", write_cost_import_fixture.path
    click_button "Import"

    expect(page).to have_content("Costs imported")

    visit cost_hub_path(start_date: "2024-01-01", end_date: "2024-01-31")

    expect(page).to have_content("$460.00")
    expect(page).to have_content("Units delivered")
    expect(page).to have_content("4")
    expect(page).to have_content("$115.00")
    expect(page).to have_css("tbody tr", count: 2)
  end

  def write_cost_import_fixture
    file = Tempfile.new([ "costs_import", ".xlsx" ])
    file.binmode
    file.write(Base64.decode64(cost_import_fixture_base64))
    file.close
    file
  end

  def cost_import_fixture_base64
    <<~BASE64
      UEsDBBQAAAAIAGJvP1xGx01IlQAAAM0AAAAQAAAAZG9jUHJvcHMvYXBwLnhtbE3PTQvCMAwG4L9SdreZih6kDkQ9ip68zy51hbYpbYT67+0EP255ecgboi6JIia2mEXxLuRtMzLHDUDWI/o+y8qhiqHke64x3YGMsRoPpB8eA8OibdeAhTEMOMzit7Dp1C5GZ3XPlkJ3sjpRJsPiWDQ6sScfq9wcChDneiU+ixNLOZcrBf+LU8sVU57mym/8ZAW/B7oXUEsDBBQAAAAIAGJvP1zMZpMl6gAAAMsBAAARAAAAZG9jUHJvcHMvY29yZS54bWylkU1PwzAMhv/K1HvrpoVJRF0uIE4gITEJxC1KvC2i+VBi1O7fk5atA8GNY/w+fmwrnQpc+YhP0QeMZDCtRtu7xFXYFAeiwAGSOqCVqcqEy+HORyspP+MeglTvco/Q1PUaLJLUkiRMwjIsxuKk1GpRho/YzwKtAHu06CgBqxhcWMJo058Nc7KQYzILNQxDNbQzlzdi8Pr48DwvXxqXSDqFhei04iqiJB/FdFE4jn0H34rdafZXAfUqT+B0DLgpzslLe3u3vS9EUzfrsmZly7as5dc3vL56m1w/+i9C67XZmX8YzwLRwa9/E59QSwMEFAAAAAgAYm8/XJlcnCMQBgAAnCcAABMAAAB4bC90aGVtZS90aGVtZTEueG1s7Vpbc9o4FH7vr9B4Z/ZtC8Y2gba0E3Npdtu0mYTtTh+FEViNbHlkkYR/v0c2EMuWDe2STbqbPAQs6fvORUfn6Dh58+4uYuiGiJTyeGDZL9vWu7cv3uBXMiQRQTAZp6/wwAqlTF61WmkAwzh9yRMSw9yCiwhLeBTL1lzgWxovI9bqtNvdVoRpbKEYR2RgfV4saEDQVFFab18gtOUfM/gVy1SNZaMBE1dBJrmItPL5bMX82t4+Zc/pOh0ygW4wG1ggf85vp+ROWojhVMLEwGpnP1Zrx9HSSICCyX2UBbpJ9qPTFQgyDTs6nVjOdnz2xO2fjMradDRtGuDj8Xg4tsvSi3AcBOBRu57CnfRsv6RBCbSjadBk2PbarpGmqo1TT9P3fd/rm2icCo1bT9Nrd93TjonGrdB4Db7xT4fDronGq9B062kmJ/2ua6TpFmhCRuPrehIVteVA0yAAWHB21szSA5ZeKfp1lBrZHbvdQVzwWO45iRH+xsUE1mnSGZY0RnKdkAUOADfE0UxQfK9BtorgwpLSXJDWzym1UBoImsiB9UeCIcXcr/31l7vJpDN6nX06zmuUf2mrAaftu5vPk/xz6OSfp5PXTULOcLwsCfH7I1thhyduOxNyOhxnQnzP9vaRpSUyz+/5CutOPGcfVpawXc/P5J6MciO73fZYffZPR24j16nAsyLXlEYkRZ/ILbrkETi1SQ0yEz8InYaYalAcAqQJMZahhvi0xqwR4BN9t74IyN+NiPerb5o9V6FYSdqE+BBGGuKcc+Zz0Wz7B6VG0fZVvNyjl1gVAZcY3zSqNSzF1niVwPGtnDwdExLNlAsGQYaXJCYSqTl+TUgT/iul2v6c00DwlC8k+kqRj2mzI6d0Js3oMxrBRq8bdYdo0jx6/gX5nDUKHJEbHQJnG7NGIYRpu/AerySOmq3CEStCPmIZNhpytRaBtnGphGBaEsbReE7StBH8Waw1kz5gyOzNkXXO1pEOEZJeN0I+Ys6LkBG/HoY4SprtonFYBP2eXsNJweiCy2b9uH6G1TNsLI73R9QXSuQPJqc/6TI0B6OaWQm9hFZqn6qHND6oHjIKBfG5Hj7lengKN5bGvFCugnsB/9HaN8Kr+ILAOX8ufc+l77n0PaHStzcjfWfB04tb3kZuW8T7rjHa1zQuKGNXcs3Ix1SvkynYOZ/A7P1oPp7x7frZJISvmlktIxaQS4GzQSS4/IvK8CrECehkWyUJy1TTZTeKEp5CG27pU/VKldflr7kouDxb5OmvoXQ+LM/5PF/ntM0LM0O3ckvqtpS+tSY4SvSxzHBOHssMO2c8kh22d6AdNfv2XXbkI6UwU5dDuBpCvgNtup3cOjiemJG5CtNSkG/D+enFeBriOdkEuX2YV23n2NHR++fBUbCj7zyWHceI8qIh7qGGmM/DQ4d5e1+YZ5XGUDQUbWysJCxGt2C41/EsFOBkYC2gB4OvUQLyUlVgMVvGAyuQonxMjEXocOeXXF/j0ZLj26ZltW6vKXcZbSJSOcJpmBNnq8reZbHBVR3PVVvysL5qPbQVTs/+Wa3InwwRThYLEkhjlBemSqLzGVO+5ytJxFU4v0UzthKXGLzj5sdxTlO4Ena2DwIyubs5qXplMWem8t8tDAksW4hZEuJNXe3V55ucrnoidvqXd8Fg8v1wyUcP5TvnX/RdQ65+9t3j+m6TO0hMnHnFEQF0RQIjlRwGFhcy5FDukpAGEwHNlMlE8AKCZKYcgJj6C73yDLkpFc6tPjl/RSyDhk5e0iUSFIqwDAUhF3Lj7++TaneM1/osgW2EVDJk1RfKQ4nBPTNyQ9hUJfOu2iYLhdviVM27Gr4mYEvDem6dLSf/217UPbQXPUbzo5ngHrOHc5t6uMJFrP9Y1h75Mt85cNs63gNe5hMsQ6R+wX2KioARq2K+uq9P+SWcO7R78YEgm/zW26T23eAMfNSrWqVkKxE/Swd8H5IGY4xb9DRfjxRiraaxrcbaMQx5gFjzDKFmON+HRZoaM9WLrDmNCm9B1UDlP9vUDWj2DTQckQVeMZm2NqPkTgo83P7vDbDCxI7h7Yu/AVBLAwQUAAAACABibz9cSspLAV4CAAAgCQAAGAAAAHhsL3dvcmtzaGVldHMvc2hlZXQxLnhtbJWW227iMBCGXyXKfZsQlt1VFSIVKOdD1Wp3L5FJBhLhxFl7gO3b1w6HBmQb7VVs//7G4xlP7PDA+FakAOj8y2kh2m6KWD55nohTyIl4ZCUUUlkznhOUXb7xRMmBJBWUUy/w/e9eTrLCjcJq7JVHIdshzQp45Y7Y5TnhHx2g7NB2G+554C3bpFgNeFFYkg28A/4qJSC73sVOkuVQiIwVDod1231uPC2aFVHN+J3BQdTajtrMirGt6oyStusrn4BCjMoEkZ89dIFSZUl68vdk1P1aVJH19tl8v9q/dG9FBHQZ/ZMlmLbdn66TwJrsKL6xwxBOe2p9udgjSKKQs4PD1WajMFYNtaScmBUqSO/I5XgmV8KoBJ6xZIkfJYQeSkfUsBefsM4dTCDhuEwI6uCuCU7ZjovliuQaqGeHoNhooBc7lK83S0GoPAMatn+fVS2qYwd2FtkuTjXY0IRxGUhDXEZWRh+WsZWxRmVyFzUGZWpFTTGZmShZBPKsEbqMmUANODeBDFPgFSU02MKEFQzhBvBkNV1KKriUVGCwcADY6mrJND/wg28PfuPBb+mK6Eipf90+CkJvX6+VuuZfay8WrW/RBhZtWNdaN+LIAo4t2sSiTS3a7Cow/o06r6uNG3FhykSHYJw6z5bsNy/Zb/5n9k3zz9lvBLrsN80B6NW1xk32LVzfog0s2tCija58uU3G2EJOLNrUos2alrM4t4ALUyKOye/oku/Vblb1cpgRvskK4VBYS1P+4w95//LjVXzsICurl8aKIbK8aqbyBQNcTZD6msm/zLmjngKXR1H0CVBLAwQUAAAACABibz9c0gXxRlICAABHCgAADQAAAHhsL3N0eWxlcy54bWzdVtuK2zAQ/RXjD6iTmJq4JHmoIVBoy8LuQ1/lWE4EuriyvCT9+mok57ab41L6VpvgmTk6M2ekMc6qdyfJnw+cu+SopO7X6cG57lOW9bsDV6z/YDquPdIaq5jzrt1nfWc5a3oiKZktZrMiU0zodLPSg9oq1yc7M2i3Tmdpkm1WrdHX0DyNAb+WKZ68MrlOKyZFbUVczJSQpxhfhMjOSGMT59VwolOo/xUXzEeXpI65lNDGhmgWy4RH7xMLKS8qFmkMbFYdc45bvfVOJIXoe2y0X06dV7G37DRffExvGOHhy9TGNtzetRtDm5XkrSOGFftDMJzp6FEb54wiqxFsbzSLSs600fC5d1zKZzqvH+1dgWObxI3/0oQ9p47Pplc1mjHN6FCB23Qx+b/n7cSrcZ8H35AO/s/BOP5keSuOwT+2bwRcagcld+Uv0YRGZZ1+pxGUNznqQUgn9OgdRNNw/b47n9+x2g/5XQG/quEtG6R7uYDr9Gp/440YVHlZ9USNjauu9lc6ynlxnVNfTOiGH3lTja7d18FMvOHLjldgvIW24QIQZEUQQATCWlAGZEUerPU/9rXEfUUQKlw+hpaYtcSsyHsIVeGGtQCr9BdouSzzvCjg9lbVYxkV3MOioB9ICBUSB9aian+78xMDMDE2f5gNeMqTYwNbnhhR2PLEzhME9pA4ZQkGANYiDjwUOFEkAtSiUQOsPKdzhgrhaz4BlSWEaEjB9BYF2qiCbnBe8CXK87IEEIFARp5DiF7YCQjKICEQyvP4IX3zPcvO37ns+tdx8xtQSwMEFAAAAAgAYm8/XLdH64rAAAAAFgIAAAsAAABfcmVscy8ucmVsc52SS24CMQxArxJlX0ypxAIxrNiwQ4gLuInno5nEkWPE9PaN2MAgaBFL/56eLa8PNKB2HHPbpWzGMMRc2VY1rQCyaylgnnGiWCo1S0AtoTSQ0PXYECzm8yXILcNu1rdMc/xJ9AqR67pztGV3ChT1Afiuw5ojSkNa2XGAM0v/zdzPCtSana+s7PynNfCmzPP1IJCiR0VwLPSRpEyLdpSvPp7dvqTzpWNitHjf6P/z0KgUPfm/nTClidLXRQkmb7D5BVBLAwQUAAAACABibz9c5LBr7jABAAAoAgAADwAAAHhsL3dvcmtib29rLnhtbI2Q0U7DMAxFf6XKB9BugklM616YgEkIEEN7z1p3tZbEleNusK8nSSlM4oUnx9fWyb1enIgPO6JD9mGN83MuVSvSzfPcVy1Y7a+oAxdmDbHVElre59Q0WMGKqt6Ck3xaFLOcwWhBcr7FzquB9h+W7xh07VsAsWZAWY1OLRejs1fO8suOBKr4U1SjskU4+d+F2GZH9LhDg/JZqvQ2oDKLDi2eoS5VoTLf0umRGM/kRJtNxWRMqSbDYAssWP2RN9Hmu975pIjevcXMpZoVAdgge0kbia+DySOE5aHrhe7RCPBKCzww9R26fcKEGPlFjnSKsWZOWyhVokYLoazrwY4EzkU4nmMY8Lr+Jo6YGhp0UD8Hjo+DEKoKF40lkabXN5PbYL435i5oL+6JdP3jazzq8gtQSwMEFAAAAAgAYm8/XDPr47qtAAAA+wEAABoAAAB4bC9fcmVscy93b3JrYm9vay54bWwucmVsc7WRPQ6DMAyFrxLlABio1KECpi6sFReIgvkRgUSxq8LtG8EASB26MFnPlr/3ZGcvNIp7O1HXOxLzaCbKZcfsHgCkOxwVRdbhFCaN9aPiIH0LTulBtQhpHN/BHxmyyI5MUS0O/yHapuk1Pq1+jzjxDzB8rB+oQ2QpKuVb5FzCbPY2wVqSKJClKOtc+rJOpIDLEhEvBmmPs+mTf3qlP4dd3O1XuTXPR7itIeD06+ILUEsDBBQAAAAIAGJvP1ybhkKEGwEAANcDAAATAAAAW0NvbnRlbnRfVHlwZXNdLnhtbK2Tz07DMAzGX6XqdWozOHBA6y6MK+zAC4TEXaPmn2JvdG+P27JKoLENlUujxvb3c/wlq7djBMw6Zz1WeUMUH4VA1YCTWIYIniN1SE4S/6adiFK1cgfifrl8ECp4Ak8F9Rr5erWBWu4tZc8db6MJvsoTWMyzpzGxZ1W5jNEaJYnj4uD1D0rxRSi5csjBxkRccEKeibOIIfQr4VT4eoCUjIZsKxO9SMdporMC6WgBy8saZ7oMdW0U6KD2jktKjAmkxgaAnC1H0cUVNPGQYfzezW5gkLlI5NRtChHZtQR/551s6auLyEKQyFw55IRk7dknhN5xDfpWOE/4I6R28ATFsMwf83efJ/1bGnkPof3ve9avpZPGTw2I4T2vPwFQSwECFAMUAAAACABibz9cRsdNSJUAAADNAAAAEAAAAAAAAAAAAAAAgAEAAAAAZG9jUHJvcHMvYXBwLnhtbFBLAQIUAxQAAAAIAGJvP1zMZpMl6gAAAMsBAAARAAAAAAAAAAAAAACAAcMAAABkb2NQcm9wcy9jb3JlLnhtbFBLAQIUAxQAAAAIAGJvP1yZXJwjEAYAAJwnAAATAAAAAAAAAAAAAACAAdwBAAB4bC90aGVtZS90aGVtZTEueG1sUEsBAhQDFAAAAAgAYm8/XErKSwFeAgAAIAkAABgAAAAAAAAAAAAAAICBHQgAAHhsL3dvcmtzaGVldHMvc2hlZXQxLnhtbFBLAQIUAxQAAAAIAGJvP1zSBfFGUgIAAEcKAAANAAAAAAAAAAAAAACAAbEKAAB4bC9zdHlsZXMueG1sUEsBAhQDFAAAAAgAYm8/XLdH64rAAAAAFgIAAAsAAAAAAAAAAAAAAIABLg0AAF9yZWxzLy5yZWxzUEsBAhQDFAAAAAgAYm8/XOSwa+4wAQAAKAIAAA8AAAAAAAAAAAAAAIABFw4AAHhsL3dvcmtib29rLnhtbFBLAQIUAxQAAAAIAGJvP1wz6+O6rQAAAPsBAAAaAAAAAAAAAAAAAACAAXQPAAB4bC9fcmVscy93b3JrYm9vay54bWwucmVsc1BLAQIUAxQAAAAIAGJvP1ybhkKEGwEAANcDAAATAAAAAAAAAAAAAACAAVkQAABbQ29udGVudF9UeXBlc10ueG1sUEsFBgAAAAAJAAkAPgIAAKURAAAAAA==\n+    BASE64
  end
end
