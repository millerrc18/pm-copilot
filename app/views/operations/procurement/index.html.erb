<% content_for :page_title, "Operations Procurement" %>
<% content_for :page_subtitle, "Track material spend, supplier concentration, and cost trends." %>

<div class="flex flex-wrap items-start justify-between gap-4">
  <div>
    <h2 class="text-lg font-semibold">Procurement dashboard</h2>
    <p class="mt-1 text-sm text-light-text/60">Monitor materials spend, suppliers, and lead time signals.</p>
    <p class="mt-2 text-xs text-light-text/50">
      <%= link_to "Procurement guide", doc_path("procurement_dashboard"), class: "text-light-text/70 hover:text-light-text" %>
    </p>
  </div>
  <div class="flex flex-wrap gap-3">
    <%= link_to "Operations imports", ops_imports_path(program_id: @program&.id), class: "inline-flex items-center justify-center rounded-full border border-white/10 bg-white/5 px-5 py-2.5 text-sm font-semibold text-light-text/80 hover:bg-white/10 focus-ring" %>
  </div>
</div>

<% if @operations_empty %>
  <%= render "operations/empty_state", program_id: @program&.id %>
<% end %>

<div class="mt-6 panel p-6">
  <% if @no_programs %>
    <div class="mb-6 rounded-2xl border border-white/10 bg-white/5 px-4 py-3 text-sm text-light-text/70">
      You do not have any programs yet. Create a program to unlock Operations dashboards.
      <%= link_to "Create a program", new_program_path, class: "ml-2 font-semibold text-light-text/90 hover:text-light-text" %>
    </div>
  <% elsif @program_missing %>
    <div class="mb-6 rounded-2xl border border-white/10 bg-white/5 px-4 py-3 text-sm text-light-text/70">
      Select a program to load procurement metrics and charts.
    </div>
  <% end %>

  <%= form_with url: operations_procurement_path, method: :get, local: true, class: "grid gap-4 md:grid-cols-4" do |f| %>
    <div>
      <%= f.label :program_id, "Program", class: "text-sm font-semibold" %>
      <%= f.select :program_id,
                   options_from_collection_for_select(@programs, :id, :name, @program&.id),
                   { include_blank: "Select a program" },
                   class: "mt-2 w-full rounded-2xl border border-white/10 bg-white/5 px-4 py-3 text-sm text-light-text focus-ring" %>
    </div>
    <div>
      <%= f.label :start_date, "Start date", class: "text-sm font-semibold" %>
      <%= f.date_field :start_date, value: @start_date, class: "mt-2 w-full rounded-2xl border border-white/10 bg-white/5 px-4 py-3 text-sm text-light-text focus-ring" %>
    </div>
    <div>
      <%= f.label :end_date, "End date", class: "text-sm font-semibold" %>
      <%= f.date_field :end_date, value: @end_date, class: "mt-2 w-full rounded-2xl border border-white/10 bg-white/5 px-4 py-3 text-sm text-light-text focus-ring" %>
    </div>
    <div>
      <%= f.label :supplier, "Supplier", class: "text-sm font-semibold" %>
      <%= f.text_field :supplier, value: @supplier, placeholder: "Acme", class: "mt-2 w-full rounded-2xl border border-white/10 bg-white/5 px-4 py-3 text-sm text-light-text focus-ring" %>
    </div>
    <div>
      <%= f.label :commodity, "Commodity", class: "text-sm font-semibold" %>
      <%= f.text_field :commodity, value: @commodity, placeholder: "Fasteners", class: "mt-2 w-full rounded-2xl border border-white/10 bg-white/5 px-4 py-3 text-sm text-light-text focus-ring" %>
    </div>
    <div>
      <%= f.label :buyer, "Buyer", class: "text-sm font-semibold" %>
      <%= f.text_field :buyer, value: @buyer, placeholder: "Ops", class: "mt-2 w-full rounded-2xl border border-white/10 bg-white/5 px-4 py-3 text-sm text-light-text focus-ring" %>
    </div>
    <div>
      <%= f.label :part_number, "Part number", class: "text-sm font-semibold" %>
      <%= f.text_field :part_number, value: @part_number, placeholder: "PN-100", class: "mt-2 w-full rounded-2xl border border-white/10 bg-white/5 px-4 py-3 text-sm text-light-text focus-ring" %>
    </div>
    <div class="flex items-end">
      <%= f.submit "Apply filters", class: "inline-flex w-full items-center justify-center rounded-full border border-white/10 bg-white/5 px-5 py-2.5 text-sm font-semibold text-light-text/80 hover:bg-white/10 focus-ring" %>
    </div>
  <% end %>

  <div class="mt-4 flex flex-wrap items-center gap-3 text-sm text-light-text/70">
    <%= button_to "Save as default",
                  ops_procurement_saved_view_path,
                  method: :post,
                  params: { program_id: @program&.id, supplier: @supplier, commodity: @commodity, buyer: @buyer, part_number: @part_number, start_date: @start_date, end_date: @end_date },
                  class: "inline-flex items-center justify-center rounded-full border border-white/10 bg-white/5 px-4 py-2 font-semibold text-light-text/80 hover:bg-white/10 focus-ring" %>
    <% if @saved_filters.present? %>
      <%= button_to "Reset saved view",
                    ops_procurement_saved_view_path,
                    method: :delete,
                    class: "inline-flex items-center justify-center rounded-full border border-white/10 px-4 py-2 font-semibold text-light-text/70 hover:bg-white/10 focus-ring" %>
      <span><%= @using_saved_filters ? "Saved view applied." : "Saved view is ready to apply on your next visit." %></span>
    <% else %>
      <span>Save the applied filters as your default view.</span>
    <% end %>
  </div>
</div>

<% if @no_materials %>
  <div class="mt-6 rounded-2xl border border-white/10 bg-white/5 px-4 py-4 text-sm text-light-text/70">
    No procurement records match the current filters. Import Operations data to see spend trends and supplier insights.
  </div>
<% end %>

<div class="mt-6 grid gap-6 lg:grid-cols-4">
  <div class="panel p-5">
    <p class="text-xs uppercase tracking-[0.2em] text-light-text/50">Material spend</p>
    <p class="mt-2 text-2xl font-semibold"><%= number_to_currency(@summary[:total_spend]) %></p>
  </div>
  <div class="panel p-5">
    <p class="text-xs uppercase tracking-[0.2em] text-light-text/50">Top supplier</p>
    <p class="mt-2 text-2xl font-semibold"><%= @summary[:top_supplier].presence || "None" %></p>
  </div>
  <div class="panel p-5">
    <p class="text-xs uppercase tracking-[0.2em] text-light-text/50">Top commodity</p>
    <p class="mt-2 text-2xl font-semibold"><%= @summary[:top_commodity].presence || "None" %></p>
  </div>
  <div class="panel p-5">
    <p class="text-xs uppercase tracking-[0.2em] text-light-text/50">Unique parts</p>
    <p class="mt-2 text-2xl font-semibold"><%= @summary[:unique_parts] %></p>
  </div>
</div>

<div class="mt-6 grid gap-6 lg:grid-cols-2">
  <div class="panel p-6">
    <div class="flex items-center justify-between gap-4">
      <div>
        <h3 class="text-base font-semibold">Spend by commodity</h3>
        <p class="mt-1 text-sm text-light-text/60">Top categories by total spend.</p>
      </div>
    </div>
    <div class="mt-4 h-56 overflow-hidden sm:h-64">
      <canvas
        class="h-full w-full max-w-full"
        data-controller="chart"
        data-chart-type-value="bar"
        data-chart-labels-value="<%= @commodity_labels.to_json %>"
        data-chart-datasets-value="<%= [{ label: "Spend", data: @commodity_totals }].to_json %>"></canvas>
    </div>
  </div>
  <div class="panel p-6">
    <div class="flex items-center justify-between gap-4">
      <div>
        <h3 class="text-base font-semibold">Spend over time</h3>
        <p class="mt-1 text-sm text-light-text/60">Receipt date totals across the selected range.</p>
      </div>
    </div>
    <div class="mt-4 h-56 overflow-hidden sm:h-64">
      <canvas
        class="h-full w-full max-w-full"
        data-controller="chart"
        data-chart-type-value="line"
        data-chart-labels-value="<%= @time_labels.to_json %>"
        data-chart-datasets-value="<%= [{ label: "Spend", data: @time_values }].to_json %>"></canvas>
    </div>
  </div>
</div>

<div class="mt-6 panel p-6">
  <div class="flex items-center justify-between gap-4">
    <div>
      <h3 class="text-base font-semibold">Parts by spend</h3>
      <p class="mt-1 text-sm text-light-text/60">Top parts with aggregated spend and receipts.</p>
    </div>
  </div>

  <div class="mt-4 overflow-x-auto">
    <table class="w-full text-sm">
      <thead class="text-left text-xs uppercase tracking-[0.2em] text-light-text/40">
        <tr>
          <th class="pb-3">Part</th>
          <th class="pb-3">Total spend</th>
          <th class="pb-3">Qty received</th>
        </tr>
      </thead>
      <tbody class="divide-y divide-white/5">
        <% if @parts.any? %>
          <% @parts.each do |part| %>
            <tr>
              <td class="py-3"><%= part.part_number %></td>
              <td class="py-3"><%= number_to_currency(part.total_spend.to_d) %></td>
              <td class="py-3"><%= part.total_received.to_d %></td>
            </tr>
          <% end %>
        <% else %>
          <tr>
            <td colspan="3" class="py-6 text-center text-light-text/60">No material records match the current filters.</td>
          </tr>
        <% end %>
      </tbody>
    </table>
  </div>
</div>
