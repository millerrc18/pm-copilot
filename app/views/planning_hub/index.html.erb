<% content_for :page_title, "Planning Hub" %>
<% content_for :page_subtitle, "Align contracts, milestones, and deliveries on one timeline." %>
<p class="text-xs text-light-text/50">
  <%= link_to "Planning Hub guide", doc_path("planning-hub"), class: "text-light-text/70 hover:text-light-text" %>
</p>
<div class="panel p-6">
  <div class="flex flex-wrap items-center justify-between gap-4">
    <div>
      <h2 class="text-lg font-semibold">Timeline filters</h2>
      <p class="mt-1 text-sm text-light-text/60">Focus the timeline by program or item type.</p>
    </div>
  </div>
  <%= form_with url: planning_hub_path, method: :get, local: true, class: "mt-4 grid gap-4 md:grid-cols-3" do |form| %>
    <div>
      <%= form.label :program_id, "Program", class: "text-sm font-semibold" %>
      <%= form.select :program_id,
                      options_from_collection_for_select(@programs, :id, :name, @selected_program&.id),
                      { include_blank: "All programs" },
                      class: "mt-2 w-full rounded-2xl border border-white/10 bg-white/5 px-4 py-3 text-sm text-light-text focus-ring" %>
    </div>
    <div>
      <%= form.label :item_type, "Item type", class: "text-sm font-semibold" %>
      <%= form.select :item_type,
                      [["All items", ""], ["Contracts", "contracts"], ["Milestones", "milestones"], ["Delivery units", "delivery_units"]],
                      { selected: @selected_type },
                      class: "mt-2 w-full rounded-2xl border border-white/10 bg-white/5 px-4 py-3 text-sm text-light-text focus-ring" %>
    </div>
    <div class="flex items-end gap-2">
      <%= form.submit "Apply filters", class: "inline-flex items-center justify-center rounded-full bg-accent-red px-4 py-2.5 text-sm font-semibold text-white transition hover:bg-accent-red/90 focus-ring" %>
      <%= link_to "Reset", planning_hub_path, class: "inline-flex items-center justify-center rounded-full border border-white/10 bg-white/5 px-4 py-2.5 text-sm font-semibold text-light-text/80 hover:bg-white/10 focus-ring" %>
    </div>
  <% end %>
</div>

<div class="mt-6 space-y-4">
  <% if @timeline_items.any? %>
    <% @timeline_items.each do |item| %>
      <div class="panel p-5" data-testid="planning-item-<%= item.kind %>-<%= item.record.id %>">
        <div class="flex flex-wrap items-start justify-between gap-4">
          <div>
            <p class="text-xs uppercase tracking-[0.2em] text-light-text/50"><%= item.kind.tr("_", " ").titleize %></p>
            <p class="mt-2 text-lg font-semibold"><%= item.title %></p>
            <p class="mt-1 text-sm text-light-text/60"><%= item.subtitle %></p>
            <p class="mt-2 text-xs text-light-text/50">
              <%= item.program_name %>
              <% if item.date.present? %>
                Â· <%= item.date.strftime("%b %-d, %Y") %>
              <% end %>
            </p>
          </div>
          <div class="text-right">
            <div data-controller="modal">
              <button type="button"
                      class="inline-flex items-center justify-center rounded-full border border-white/10 bg-white/5 px-4 py-2 text-xs font-semibold text-light-text/80 hover:bg-white/10 focus-ring"
                      data-action="click->modal#open">
                Edit
              </button>
              <dialog data-modal-target="dialog" data-testid="planning-modal-<%= item.kind %>-<%= item.record.id %>" class="w-full max-w-xl rounded-3xl border border-white/10 bg-dark-panel-strong p-0 text-left text-light-text">
                <div class="flex items-center justify-between border-b border-white/10 px-6 py-4">
                  <h3 class="text-sm font-semibold">Edit <%= item.title %></h3>
                  <button type="button" class="text-light-text/60 hover:text-light-text" data-action="modal#close">Close</button>
                </div>
                <div class="p-6">
                  <% if item.kind == "contracts" %>
                    <%= form_with model: item.record, local: true, class: "space-y-4" do |form| %>
                      <%= hidden_field_tag :return_to, planning_hub_path %>
                      <div>
                        <%= form.label :contract_code, "Contract code", class: "text-sm font-semibold" %>
                        <%= form.text_field :contract_code, class: "mt-2 w-full rounded-2xl border border-white/10 bg-white/5 px-4 py-3 text-sm text-light-text focus-ring" %>
                      </div>
                      <div class="grid gap-4 md:grid-cols-2">
                        <div>
                          <%= form.label :start_date, class: "text-sm font-semibold" %>
                          <%= form.date_field :start_date, class: "mt-2 w-full rounded-2xl border border-white/10 bg-white/5 px-4 py-3 text-sm text-light-text focus-ring" %>
                        </div>
                        <div>
                          <%= form.label :end_date, class: "text-sm font-semibold" %>
                          <%= form.date_field :end_date, class: "mt-2 w-full rounded-2xl border border-white/10 bg-white/5 px-4 py-3 text-sm text-light-text focus-ring" %>
                        </div>
                      </div>
                      <div class="grid gap-4 md:grid-cols-2">
                        <div>
                          <%= form.label :planned_quantity, class: "text-sm font-semibold" %>
                          <%= form.number_field :planned_quantity, min: 0, class: "mt-2 w-full rounded-2xl border border-white/10 bg-white/5 px-4 py-3 text-sm text-light-text focus-ring" %>
                        </div>
                        <div>
                          <%= form.label :sell_price_per_unit, class: "text-sm font-semibold" %>
                          <%= form.number_field :sell_price_per_unit, step: 0.01, class: "mt-2 w-full rounded-2xl border border-white/10 bg-white/5 px-4 py-3 text-sm text-light-text focus-ring" %>
                        </div>
                      </div>
                      <div class="flex flex-wrap gap-3">
                        <%= form.submit "Save changes", class: "inline-flex items-center justify-center rounded-full bg-accent-red px-4 py-2.5 text-sm font-semibold text-white transition hover:bg-accent-red/90 focus-ring" %>
                        <button type="button" class="inline-flex items-center justify-center rounded-full border border-white/10 bg-white/5 px-4 py-2.5 text-sm font-semibold text-light-text/80 hover:bg-white/10 focus-ring" data-action="modal#close">Cancel</button>
                      </div>
                    <% end %>
                  <% elsif item.kind == "milestones" %>
                    <%= form_with model: item.record, local: true, class: "space-y-4" do |form| %>
                      <%= hidden_field_tag :return_to, planning_hub_path %>
                      <div>
                        <%= form.label :milestone_ref, "Milestone reference", class: "text-sm font-semibold" %>
                        <%= form.text_field :milestone_ref, class: "mt-2 w-full rounded-2xl border border-white/10 bg-white/5 px-4 py-3 text-sm text-light-text focus-ring" %>
                      </div>
                      <div class="grid gap-4 md:grid-cols-2">
                        <div>
                          <%= form.label :due_date, class: "text-sm font-semibold" %>
                          <%= form.date_field :due_date, class: "mt-2 w-full rounded-2xl border border-white/10 bg-white/5 px-4 py-3 text-sm text-light-text focus-ring" %>
                        </div>
                        <div>
                          <%= form.label :quantity_due, "Quantity due", class: "text-sm font-semibold" %>
                          <%= form.number_field :quantity_due, min: 0, class: "mt-2 w-full rounded-2xl border border-white/10 bg-white/5 px-4 py-3 text-sm text-light-text focus-ring" %>
                        </div>
                      </div>
                      <div>
                        <%= form.label :notes, class: "text-sm font-semibold" %>
                        <%= form.text_area :notes, rows: 3, class: "mt-2 w-full rounded-2xl border border-white/10 bg-white/5 px-4 py-3 text-sm text-light-text focus-ring" %>
                      </div>
                      <div class="flex flex-wrap gap-3">
                        <%= form.submit "Save changes", class: "inline-flex items-center justify-center rounded-full bg-accent-red px-4 py-2.5 text-sm font-semibold text-white transition hover:bg-accent-red/90 focus-ring" %>
                        <button type="button" class="inline-flex items-center justify-center rounded-full border border-white/10 bg-white/5 px-4 py-2.5 text-sm font-semibold text-light-text/80 hover:bg-white/10 focus-ring" data-action="modal#close">Cancel</button>
                      </div>
                    <% end %>
                  <% else %>
                    <%= form_with model: item.record, local: true, class: "space-y-4" do |form| %>
                      <%= hidden_field_tag :return_to, planning_hub_path %>
                      <div>
                        <%= form.label :unit_serial, "Unit serial", class: "text-sm font-semibold" %>
                        <%= form.text_field :unit_serial, class: "mt-2 w-full rounded-2xl border border-white/10 bg-white/5 px-4 py-3 text-sm text-light-text focus-ring" %>
                      </div>
                      <div>
                        <%= form.label :ship_date, class: "text-sm font-semibold" %>
                        <%= form.date_field :ship_date, class: "mt-2 w-full rounded-2xl border border-white/10 bg-white/5 px-4 py-3 text-sm text-light-text focus-ring" %>
                      </div>
                      <div>
                        <%= form.label :notes, class: "text-sm font-semibold" %>
                        <%= form.text_area :notes, rows: 3, class: "mt-2 w-full rounded-2xl border border-white/10 bg-white/5 px-4 py-3 text-sm text-light-text focus-ring" %>
                      </div>
                      <div class="flex flex-wrap gap-3">
                        <%= form.submit "Save changes", class: "inline-flex items-center justify-center rounded-full bg-accent-red px-4 py-2.5 text-sm font-semibold text-white transition hover:bg-accent-red/90 focus-ring" %>
                        <button type="button" class="inline-flex items-center justify-center rounded-full border border-white/10 bg-white/5 px-4 py-2.5 text-sm font-semibold text-light-text/80 hover:bg-white/10 focus-ring" data-action="modal#close">Cancel</button>
                      </div>
                    <% end %>
                  <% end %>
                </div>
              </dialog>
            </div>
          </div>
        </div>
      </div>
    <% end %>
  <% else %>
    <div class="panel p-6">
      <p class="text-sm text-light-text/60">No items yet. Add milestones or delivery units to build a timeline.</p>
    </div>
  <% end %>
</div>
