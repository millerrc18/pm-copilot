<% content_for :page_title, @program.name %>
<% content_for :page_subtitle, @program.customer.presence || "Program overview" %>
<% content_for :toolbar do %>
  <%= render "shared/ui/button", label: "Add contract", variant: "primary", url: new_program_contract_path(@program) %>
  <%= render "shared/ui/button", label: "Edit", variant: "ghost", url: edit_program_path(@program) %>
<% end %>

<div class="grid gap-6 lg:grid-cols-[minmax(0,1fr)_320px]">
  <div class="space-y-6">
    <div class="panel p-6">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-xs uppercase tracking-[0.2em] text-light-text/50">Overview</p>
          <p class="mt-2 text-lg font-semibold">Program snapshot</p>
          <p class="mt-2 text-sm text-light-text/60">Track contract performance, delivery, and margin.</p>
        </div>
        <%= render "shared/ui/button", label: "Back", variant: "ghost", url: programs_path %>
      </div>
      <% if @program.description.present? %>
        <p class="mt-4 text-sm text-light-text/70"><%= simple_format(@program.description) %></p>
      <% end %>
    </div>

    <% if defined?(@dashboard) && @dashboard.present? %>
      <div class="grid gap-4 md:grid-cols-2 xl:grid-cols-3">
        <div class="panel p-5">
          <p class="text-sm text-light-text/60">Revenue to date</p>
          <p class="mt-3 text-2xl font-semibold"><%= number_to_currency(@dashboard[:totals][:revenue_to_date]) %></p>
          <p class="mt-2 text-xs text-light-text/50">Across all contracts</p>
        </div>
        <div class="panel p-5">
          <p class="text-sm text-light-text/60">Cost to date</p>
          <p class="mt-3 text-2xl font-semibold"><%= number_to_currency(@dashboard[:totals][:cost_to_date]) %></p>
          <p class="mt-2 text-xs text-light-text/50">Updated this week</p>
        </div>
        <div class="panel p-5">
          <p class="text-sm text-light-text/60">Profit to date</p>
          <p class="mt-3 text-2xl font-semibold <%= @dashboard[:totals][:profit_to_date].to_d < 0 ? "text-accent-red" : "text-light-text" %>">
            <%= number_to_currency(@dashboard[:totals][:profit_to_date]) %>
          </p>
          <p class="mt-2 text-xs text-light-text/50">Revenue minus cost</p>
        </div>
        <div class="panel p-5">
          <p class="text-sm text-light-text/60">
            <span title="Return on sales equals profit divided by revenue. Shows N/A when revenue is zero.">Return on sales</span>
          </p>
          <p class="mt-3 text-2xl font-semibold">
            <% if @dashboard[:totals][:ros_to_date].present? %>
              <%= (@dashboard[:totals][:ros_to_date].to_d * 100).round(1) %>%
            <% else %>
              N/A
            <% end %>
          </p>
          <p class="mt-2 text-xs text-light-text/50">ROS</p>
        </div>
        <div class="panel p-5">
          <p class="text-sm text-light-text/60">
            <span title="Return on cost equals profit divided by cost. Shows N/A when cost is zero.">Return on cost</span>
          </p>
          <p class="mt-3 text-2xl font-semibold">
            <% if @dashboard[:totals][:roc_to_date].present? %>
              <%= (@dashboard[:totals][:roc_to_date].to_d * 100).round(1) %>%
            <% else %>
              N/A
            <% end %>
          </p>
          <p class="mt-2 text-xs text-light-text/50">ROC</p>
        </div>
        <div class="panel p-5">
          <p class="text-sm text-light-text/60">OTD to date</p>
          <p class="mt-3 text-2xl font-semibold"><%= (@dashboard[:totals][:otd_pct_to_date].to_d * 100).round(1) %>%</p>
          <p class="mt-2 text-xs text-light-text/50">Past due: <%= @dashboard[:totals][:past_due_units] %> units</p>
        </div>
      </div>

      <div class="panel p-6">
        <div class="flex flex-wrap items-center justify-between gap-4">
          <div>
            <h2 class="text-lg font-semibold">Contracts</h2>
            <p class="text-sm text-light-text/60">Rollup by contract. Click a contract code to view details.</p>
          </div>
          <%= render "shared/ui/button", label: "Add contract", variant: "primary", url: new_program_contract_path(@program) %>
        </div>

        <% if @dashboard[:contracts].any? %>
          <div class="mt-4 space-y-3">
            <% @dashboard[:contracts].each do |r| %>
              <div class="flex flex-wrap items-center justify-between gap-3 rounded-2xl border border-white/10 bg-white/5 p-4">
                <div>
                  <p class="text-sm font-semibold"><%= link_to r[:contract_code], contract_path(r[:id]), class: "hover:text-light-text" %></p>
                  <p class="text-xs text-light-text/50">FY <%= r[:fiscal_year] %> Â· Planned <%= r[:planned_units] %> units</p>
                </div>
                <div class="text-xs text-light-text/50">
                  Revenue <span class="text-light-text"><%= number_to_currency(r[:revenue_to_date]) %></span>
                </div>
                <div class="flex gap-2">
                  <%= render "shared/ui/button", label: "View", variant: "ghost", url: contract_path(r[:id]) %>
                  <%= render "shared/ui/button", label: "Edit", variant: "ghost", url: edit_contract_path(r[:id]) %>
                </div>
              </div>
            <% end %>
          </div>
        <% else %>
          <p class="mt-4 text-sm text-light-text/60">No contracts yet for this program.</p>
        <% end %>
      </div>
    <% else %>
      <div class="panel p-6">
        <div class="flex flex-wrap items-center justify-between gap-4">
          <div>
            <h2 class="text-lg font-semibold">Contracts</h2>
            <p class="text-sm text-light-text/60">No dashboard data yet.</p>
          </div>
          <%= render "shared/ui/button", label: "Add contract", variant: "primary", url: new_program_contract_path(@program) %>
        </div>
      </div>
    <% end %>
  </div>

  <div class="space-y-6">
    <div class="panel p-6">
      <h3 class="text-sm font-semibold">Next due</h3>
      <p class="mt-3 text-2xl font-semibold">
        <% if @dashboard&.dig(:totals, :next_due_date) %>
          <%= @dashboard[:totals][:next_due_date].strftime("%b. %-d, %Y") %>
        <% else %>
          None
        <% end %>
      </p>
      <p class="mt-2 text-sm text-light-text/60"><%= @dashboard&.dig(:totals, :next_due_units) || 0 %> units scheduled</p>
    </div>

    <div class="panel p-6">
      <h3 class="text-sm font-semibold">Average cost per unit</h3>
      <p class="mt-3 text-2xl font-semibold"><%= number_to_currency(@dashboard&.dig(:totals, :avg_cost_per_unit) || 0) %></p>
      <p class="mt-2 text-sm text-light-text/60">Based on delivered units</p>
    </div>

    <%= render "risks/summary_panel",
               title: "Risks and opportunities",
               subtitle: "Program and contract items",
               summary: @risk_summary,
               link: risks_path(program_id: @program.id) %>

    <div class="panel p-6">
      <h3 class="text-sm font-semibold">Program actions</h3>
      <div class="mt-4 space-y-3">
        <%= render "shared/ui/button", label: "Add contract", variant: "primary", url: new_program_contract_path(@program) %>
        <%= render "shared/ui/button", label: "Edit program", variant: "secondary", url: edit_program_path(@program) %>
        <%= button_to "Delete program", program_path(@program), method: :delete, data: { turbo_confirm: "Delete this program AND all contracts, costs, milestones, and delivered units under it?" }, class: "inline-flex w-full items-center justify-center rounded-full border border-white/10 bg-white/5 px-4 py-2 text-sm font-semibold text-accent-red transition hover:bg-white/10 focus-ring" %>
      </div>
    </div>
  </div>
</div>
