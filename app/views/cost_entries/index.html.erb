<% content_for :page_title, "Cost Hub" %>
<% content_for :page_subtitle, "Analyze contract-independent costs and unit efficiency." %>

<div class="flex flex-wrap items-start justify-between gap-4">
  <div>
    <h2 class="text-lg font-semibold">Cost summary</h2>
    <p class="mt-1 text-sm text-light-text/60">Review costs, delivered units, and average cost per unit.</p>
  </div>
  <div class="flex flex-wrap gap-3">
    <%= link_to "Import costs", new_cost_import_path, class: "inline-flex items-center justify-center rounded-full bg-accent-red px-5 py-2.5 text-sm font-semibold text-white transition hover:bg-accent-red/90 focus-ring" %>
  </div>
</div>

<div class="mt-6 panel p-6">
  <%= form_with url: cost_hub_path, method: :get, local: true, class: "grid gap-4 md:grid-cols-4" do |f| %>
    <div>
      <%= f.label :start_date, "Start date", class: "text-sm font-semibold" %>
      <%= f.date_field :start_date, value: @start_date, class: "mt-2 w-full rounded-2xl border border-white/10 bg-white/5 px-4 py-3 text-sm text-light-text focus-ring" %>
    </div>
    <div>
      <%= f.label :end_date, "End date", class: "text-sm font-semibold" %>
      <%= f.date_field :end_date, value: @end_date, class: "mt-2 w-full rounded-2xl border border-white/10 bg-white/5 px-4 py-3 text-sm text-light-text focus-ring" %>
    </div>
    <div>
      <%= f.label :program_id, "Program", class: "text-sm font-semibold" %>
      <%= f.select :program_id,
                   options_from_collection_for_select(@programs, :id, :name, @program&.id),
                   { include_blank: "All programs" },
                   class: "mt-2 w-full rounded-2xl border border-white/10 bg-white/5 px-4 py-3 text-sm text-light-text focus-ring" %>
    </div>
    <div class="flex items-end">
      <%= f.submit "Apply filters", class: "inline-flex w-full items-center justify-center rounded-full border border-white/10 bg-white/5 px-5 py-2.5 text-sm font-semibold text-light-text/80 hover:bg-white/10 focus-ring" %>
    </div>
  <% end %>
</div>

<div class="mt-6 grid gap-6 lg:grid-cols-3">
  <div class="panel p-5">
    <p class="text-xs uppercase tracking-[0.2em] text-light-text/50">Total cost</p>
    <p class="mt-2 text-2xl font-semibold"><%= number_to_currency(@summary[:total_cost]) %></p>
  </div>
  <div class="panel p-5">
    <p class="text-xs uppercase tracking-[0.2em] text-light-text/50">Units delivered</p>
    <p class="mt-2 text-2xl font-semibold"><%= @summary[:total_units] %></p>
  </div>
  <div class="panel p-5">
    <p class="text-xs uppercase tracking-[0.2em] text-light-text/50">Avg cost per unit</p>
    <p class="mt-2 text-2xl font-semibold"><%= number_to_currency(@summary[:average_cost_per_unit]) %></p>
  </div>
</div>

<div class="mt-6 panel p-6">
  <div class="flex items-center justify-between gap-4">
    <div>
      <h3 class="text-base font-semibold">Cost entries</h3>
      <p class="mt-1 text-sm text-light-text/60"><%= @entries.count %> entries in range.</p>
    </div>
  </div>

  <div class="mt-4 overflow-x-auto">
    <table class="w-full text-sm">
      <thead class="text-left text-xs uppercase tracking-[0.2em] text-light-text/40">
        <tr>
          <% base_params = params.permit(:start_date, :end_date, :program_id) %>
          <th class="pb-3">
            <%= link_to "Date",
                        cost_hub_path(base_params.merge(sort: "date", direction: sort_direction_for("date"))),
                        class: "hover:text-light-text" %>
          </th>
          <th class="pb-3">
            <%= link_to "Program",
                        cost_hub_path(base_params.merge(sort: "program", direction: sort_direction_for("program"))),
                        class: "hover:text-light-text" %>
          </th>
          <th class="pb-3">Labor hours</th>
          <th class="pb-3">Material cost</th>
          <th class="pb-3">Other costs</th>
          <th class="pb-3">Total cost</th>
        </tr>
      </thead>
      <tbody class="divide-y divide-white/5">
        <% if @entries.any? %>
          <% @entries.each do |entry| %>
            <tr>
              <td class="py-3"><%= entry.period_start_date %></td>
              <td class="py-3"><%= entry.program&.name || "Multiple" %></td>
              <td class="py-3"><%= entry.total_labor_hours %></td>
              <td class="py-3"><%= number_to_currency(entry.material_cost.to_d) %></td>
              <td class="py-3"><%= number_to_currency(entry.other_costs.to_d) %></td>
              <td class="py-3 font-semibold"><%= number_to_currency(entry.total_cost) %></td>
            </tr>
          <% end %>
        <% else %>
          <tr>
            <td colspan="6" class="py-6 text-center text-sm text-light-text/60">No cost entries match this range.</td>
          </tr>
        <% end %>
      </tbody>
    </table>
  </div>
</div>
