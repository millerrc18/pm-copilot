<% units_delivered = @contract.total_units_delivered.to_i %>
<% total_cost = @contract.total_cost.to_d %>
<% avg_cost_per_unit = units_delivered.zero? ? 0.to_d : (total_cost / units_delivered.to_d) %>

<div class="page-header">
  <div>
    <h1><%= @contract.contract_code %></h1>
    <p class="subtle"><%= @contract.program.name %> â€¢ FY <%= @contract.fiscal_year %></p>
  </div>

  <div class="actions">
    <%= link_to "Back to program", program_path(@contract.program), class: "btn btn-sm" %>
    <%= link_to "New contract", new_program_contract_path(@contract.program), class: "btn btn-sm btn-primary" %>

    <%= link_to "Add period", new_contract_contract_period_path(@contract), class: "btn btn-sm" %>
    <%= link_to "Import delivery units", new_contract_delivery_unit_import_path(@contract), class: "btn btn-sm" %>
    <%= link_to "Import costs", new_contract_cost_import_path(@contract), class: "btn btn-sm" %>
    <%= link_to "Import milestones", new_contract_milestone_import_path(@contract), class: "btn btn-sm" %>

    <%= link_to "Import workbook", new_contract_period_import_path(@contract), class: "btn btn-sm" %>
    <%= link_to "Edit", edit_contract_path(@contract), class: "btn btn-sm" %>
  </div>
</div>

<div class="kpi-grid">
  <div class="kpi">
    <p class="label">Units delivered</p>
    <p class="value"><%= units_delivered %></p>
    <p class="hint">Planned: <%= @contract.planned_quantity %></p>
  </div>

  <div class="kpi">
    <p class="label">Revenue</p>
    <p class="value"><%= number_to_currency(@contract.total_revenue) %></p>
    <p class="hint">Based on delivered units</p>
  </div>

  <div class="kpi">
    <p class="label">Total cost</p>
    <p class="value"><%= number_to_currency(total_cost) %></p>
    <p class="hint">Labor + material + other</p>
  </div>

  <% margin = @contract.total_margin.to_d %>
  <div class="kpi">
    <p class="label">Total margin</p>
    <p class="value <%= margin < 0 ? "negative" : "positive" %>">
      <%= number_to_currency(margin) %>
    </p>
    <p class="hint">
      Avg cost/unit: <%= number_to_currency(avg_cost_per_unit) %><br>
      Avg margin/unit: <%= number_to_currency(@contract.avg_margin_per_unit) %>
    </p>
  </div>
</div>

<div class="spacer-18"></div>

<div class="card">
  <div class="card-body">
    <div class="page-header" style="margin: 0 0 10px;">
      <div>
        <h1 style="font-size:18px;">Cost and revenue periods</h1>
        <p class="subtle">One row per week or month of actuals.</p>
      </div>
      <div class="actions">
        <%= link_to "Add period", new_contract_contract_period_path(@contract), class: "btn btn-sm btn-primary" %>
      </div>
    </div>

    <% if @periods.any? %>
      <div class="table-container">
        <table class="table">
          <thead>
            <tr>
              <th>Period start</th>
              <th>Type</th>
              <th class="num">Units</th>
              <th class="num">Rev/unit</th>
              <th class="num">Revenue</th>
              <th class="num">Cost</th>
              <th class="num">Cost/unit</th>
              <th class="num">Margin/unit</th>
              <th class="actions-cell"></th>
            </tr>
          </thead>
          <tbody>
            <% @periods.each do |p| %>
              <tr>
                <td><%= p.period_start_date&.strftime("%b. %-d, %Y") %></td>
                <td><%= p.period_type %></td>
                <td class="num"><%= p.units_delivered %></td>
                <td class="num"><%= number_to_currency(p.revenue_per_unit) %></td>
                <td class="num"><%= number_to_currency(p.revenue_total) %></td>
                <td class="num"><%= number_to_currency(p.total_cost) %></td>
                <td class="num"><%= number_to_currency(p.cost_per_unit) %></td>
                <td class="num"><%= number_to_currency(p.margin_per_unit) %></td>
                <td class="actions-cell">
                  <div class="actions">
                    <%= link_to "Edit", edit_contract_period_path(p), class: "btn btn-sm" %>
                  </div>
                </td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>
    <% else %>
      <p class="subtle">No period data yet.</p>
    <% end %>
  </div>
</div>

<div class="spacer-18"></div>

<div class="card">
  <div class="card-body">
    <div class="page-header" style="margin: 0 0 10px;">
      <div>
        <h1 style="font-size:18px;">Delivery milestones</h1>
        <p class="subtle">Contractual commitments: quantity due by date.</p>
      </div>
      <div class="actions">
        <%= link_to "Add milestone", new_contract_delivery_milestone_path(@contract), class: "btn btn-sm btn-primary" %>
      </div>
    </div>

    <% if @milestones.any? %>
      <div class="table-container">
        <table class="table">
          <thead>
            <tr>
              <th>Due date</th>
              <th class="num">Qty due</th>
              <th>Notes</th>
              <th class="actions-cell"></th>
            </tr>
          </thead>
          <tbody>
            <% @milestones.each do |m| %>
              <tr>
                <td><%= m.due_date&.strftime("%b. %-d, %Y") %></td>
                <td class="num"><%= m.quantity_due %></td>
                <td class="wrap"><%= m.notes %></td>
                <td class="actions-cell">
                  <div class="actions">
                    <%= link_to "Edit", edit_delivery_milestone_path(m), class: "btn btn-sm" %>
                  </div>
                </td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>
    <% else %>
      <p class="subtle">No milestones yet for this contract.</p>
    <% end %>
  </div>
</div>

<div class="spacer-18"></div>

<div class="card">
  <div class="card-body">
    <div class="page-header" style="margin: 0 0 10px;">
      <div>
        <h1 style="font-size:18px;">Delivered units</h1>
        <p class="subtle">Unit-level actuals: one row per unit shipped.</p>
      </div>
      <div class="actions">
        <%= link_to "Add delivered unit", new_contract_delivery_unit_path(@contract), class: "btn btn-sm btn-primary" %>
      </div>
    </div>

    <% if @units.any? %>
      <div class="table-container">
        <table class="table">
          <thead>
            <tr>
              <th>Unit serial</th>
              <th>Ship date</th>
              <th>Notes</th>
              <th class="actions-cell"></th>
            </tr>
          </thead>
          <tbody>
            <% @units.each do |u| %>
              <tr>
                <td><%= u.unit_serial %></td>
                <td><%= u.ship_date&.strftime("%b. %-d, %Y") %></td>
                <td class="wrap"><%= u.notes %></td>
                <td class="actions-cell">
                  <div class="actions">
                    <%= link_to "Edit", edit_delivery_unit_path(u), class: "btn btn-sm" %>
                  </div>
                </td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>
    <% else %>
      <p class="subtle">No delivered units recorded yet.</p>
    <% end %>
  </div>
</div>
