<% content_for :page_title, "Operations Imports" %>
<% content_for :page_subtitle, "Import IFS reports for procurement, production, efficiency, quality, and BOM." %>

<div class="flex flex-wrap items-start justify-between gap-4">
  <div>
    <h2 class="text-lg font-semibold">Operations imports</h2>
    <p class="mt-1 text-sm text-light-text/60">Upload IFS exports and track import history by program.</p>
    <p class="mt-2 text-xs text-light-text/50">
      <%= link_to "Operations import guide", doc_path("imports_ops_reports"), class: "text-light-text/70 hover:text-light-text" %>
    </p>
  </div>
</div>

<div class="mt-6 panel p-6">
  <%= form_with url: ops_imports_path, method: :post, local: true, class: "grid gap-4 md:grid-cols-4" do |f| %>
    <div>
      <%= f.label :program_id, "Program", class: "text-sm font-semibold" %>
      <%= f.select :program_id,
                   options_from_collection_for_select(@programs, :id, :name, @program&.id),
                   { include_blank: "Select a program" },
                   class: "mt-2 w-full rounded-2xl border border-white/10 bg-white/5 px-4 py-3 text-sm text-light-text focus-ring" %>
    </div>
    <div>
      <%= f.label :report_type, "Report type", class: "text-sm font-semibold" %>
      <%= f.select :report_type,
                   options_for_select(OpsImport::REPORT_TYPES.map { |type| [type.titleize, type] }, params[:report_type]),
                   { include_blank: "Select a report" },
                   class: "mt-2 w-full rounded-2xl border border-white/10 bg-white/5 px-4 py-3 text-sm text-light-text focus-ring" %>
    </div>
    <div>
      <%= f.label :file, "Excel file", class: "text-sm font-semibold" %>
      <%= f.file_field :file, class: "mt-2 w-full rounded-2xl border border-white/10 bg-white/5 px-4 py-3 text-sm text-light-text focus-ring" %>
      <p class="mt-2 text-xs text-light-text/50">Use the provided template for consistent headers.</p>
    </div>
    <div class="flex items-end">
      <%= f.submit "Import report", class: "inline-flex w-full items-center justify-center rounded-full bg-accent-red px-5 py-2.5 text-sm font-semibold text-white transition hover:bg-accent-red/90 focus-ring" %>
    </div>
  <% end %>

  <% if @errors.present? %>
    <div class="mt-4 rounded-2xl border border-rose-500/30 bg-rose-500/10 p-4 text-sm text-rose-100">
      <p class="font-semibold">Import failed</p>
      <ul class="mt-2 space-y-1">
        <% @errors.each do |error| %>
          <li><%= error %></li>
        <% end %>
      </ul>
    </div>
  <% end %>

  <div class="mt-6 grid gap-3 text-sm text-light-text/70 md:grid-cols-2">
    <div class="rounded-2xl border border-white/10 bg-white/5 p-4">
      <p class="text-xs uppercase tracking-[0.2em] text-light-text/50">Templates</p>
      <div class="mt-3 grid gap-2">
        <%= link_to "Materials template", import_template_path("materials"), class: "text-light-text/80 hover:text-light-text" %>
        <%= link_to "Shop Orders template", import_template_path("shop_orders"), class: "text-light-text/80 hover:text-light-text" %>
        <%= link_to "Shop Order Operations template", import_template_path("shop_order_operations"), class: "text-light-text/80 hover:text-light-text" %>
        <%= link_to "Historical Efficiency template", import_template_path("historical_efficiency"), class: "text-light-text/80 hover:text-light-text" %>
        <%= link_to "Scrap template", import_template_path("scrap"), class: "text-light-text/80 hover:text-light-text" %>
        <%= link_to "MRB Part Details template", import_template_path("mrb_part_details"), class: "text-light-text/80 hover:text-light-text" %>
        <%= link_to "MRB Disposition Lines template", import_template_path("mrb_dispo_lines"), class: "text-light-text/80 hover:text-light-text" %>
        <%= link_to "BOM template", import_template_path("bom"), class: "text-light-text/80 hover:text-light-text" %>
      </div>
    </div>
    <div class="rounded-2xl border border-white/10 bg-white/5 p-4">
      <p class="text-xs uppercase tracking-[0.2em] text-light-text/50">Import guidance</p>
      <p class="mt-3">Each import is program scoped and idempotent. Duplicate files are blocked to prevent accidental duplication.</p>
      <p class="mt-2">To replace a file, delete the previous import and reupload.</p>
    </div>
  </div>
</div>

<%= turbo_frame_tag "ops_import_history",
                    data: {
                      controller: "frame-refresh",
                      frame_refresh_url_value: ops_imports_path(program_id: @program&.id, frame: "history"),
                      frame_refresh_interval_value: 15000
                    } do %>
  <%= render partial: "ops_imports/history",
             locals: { imports: @imports, program: @program, last_updated_at: @imports_last_updated_at } %>
<% end %>
